#!/bin/sh

#
# check for root
#
AWK=/usr/bin/awk
RUID=`/usr/bin/id|$AWK -F\( '{print $2}'|$AWK -F\) '{print $1}'`
if [ ${RUID} = "root" ];then
  echo "You cannot be logged in as root to run $0"
  echo "Log in as a user other than root and restart $0"
  exit 1
fi

umask 0027

#
# Figure out the directory where this script resides.
#
script_dir=`dirname $0`
if [ $script_dir = "." ];then
  script_dir=`pwd -P`
fi

#
# Figure out base install directory.
# Assume the base install directory is one level up from where this
# script resides.
#
cd $script_dir
cd ..
base_dir=`pwd`
cd ..
MW_HOME=`pwd`
cd $base_dir/upgrade

#
# Get location of JRF
#
if (test -d $MW_HOME/oracle_common/modules)
then
  jrf_dir=$MW_HOME/oracle_common
else
  if (test -d $base_dir/modules)
  then
    jrf_dir=$base_dir
  else
    echo "Location of Java Required Files (JRF) not found."
    exit 1
  fi
fi

OUI_HOME=$base_dir/oui
export OUI_HOME

# Execute WebLogic script to define WL_HOME if the script exists
#
if (test -x $MW_HOME/utils/config/10.3/setHomeDirs.sh)
then
  . "$MW_HOME/utils/config/10.3/setHomeDirs.sh"
fi
  
# Look for the JDK in the Oracle home
#
if (test -x $base_dir/jdk/bin/java)
then
  JAVA_HOME=$base_dir/jdk
  export JAVA_HOME
else
  # If WebLogic is installed, then use the same JDK it uses
  # The commEnv.sh script will set JAVA_HOME
  if (test -x $WL_HOME/common/bin/commEnv.sh)
  then
    . "$WL_HOME/common/bin/commEnv.sh"
  else
    # If Websphere is installed, then use the JDK installed with Websphere
    if (test -x $MW_HOME/oracle_common/common/bin/setWasHome.sh)
    then
      . $MW_HOME/oracle_common/common/bin/setWasHome.sh
      if (test -f $WAS_HOME)
      then
        JAVA_HOME=${WAS_HOME}/java
      fi
    fi
  fi
fi

if [ "$JAVA_HOME" = "" ]
then
  echo JAVA_HOME not found. Set the JAVA_HOME environment variable and rerun.
  exit 1
fi

jdk_version_file=$base_dir/upgrade/temp/jdk_version.log
$JAVA_HOME/bin/java -version >$jdk_version_file 2>&1
cnt=`cat $jdk_version_file |grep HotSpot |wc -l`
if [ $cnt -gt 0 ] ; then
   MAXPERMSIZE=-XX:MaxPermSize=128M
fi

# Find the SOA HOME, if there is one
SOA_HOME=`$JAVA_HOME/bin/java -cp $base_dir/jlib/ua.jar -DMW_HOME=$MW_HOME oracle.ias.upgrade.SoaFinder`


if [ "$PATH" = "" ];
then
    PATH=$base_dir/bin
else
    PATH=$base_dir/bin:${PATH}
fi
export PATH

OSTYPE=`uname -s` 
export OSTYPE 

#export platform specific variables 
case $OSTYPE in 
   HP-UX) # For HP-UX 
   if [ "$SHLIB_PATH" = "" ] 
   then 
     SHLIB_PATH=$base_dir/lib
   else 
     SHLIB_PATH=$base_dir/lib:${SHLIB_PATH} 
   fi 
   export SHLIB_PATH

   JAVAMODE=-d64 # needed for HP-UX
   ;; 

   AIX) # For AIX 
   if [ "$LIBPATH" = "" ] 
   then 
      LIBPATH=$base_dir/lib
   else 
      LIBPATH=$base_dir/lib:${LIBPATH} 
   fi 
   export LIBPATH
   ;;

   SunOS) # For Sun
   ARCH=`uname -p`
   case $ARCH in
     sparc)
     JAVAMODE=-d64 # needed for Sparc
     ;;
     i386) 
     JAVAMODE=-d64 # needed for X64 
     ;; 
   esac
   ;;  
esac 

if [ "$LD_LIBRARY_PATH" = "" ]
then
  LD_LIBRARY_PATH=$base_dir/lib
else
  LD_LIBRARY_PATH=$base_dir/lib:${LD_LIBRARY_PATH}
fi
export LD_LIBRARY_PATH


# Name of the the Oracle JDBC driver
ojdbc=$jrf_dir/modules/oracle.jdbc_11.1.1/ojdbc6dms.jar 
# Name of the directory that contains the DataDirect JDBC drivers
wl_lib=$jrf_dir/modules/datadirect_4.1
fmw_dir=$jrf_dir/modules/oracle.jrf_11.1.1
datadirect_wls=$fmw_dir/fmwgenerictoken.jar:$wl_lib/wlsqlserver.jar:$wl_lib/wldb2.jar:$wl_lib/wlsybase.jar:$wl_lib/wlinformix.jar
mysql_wls=$wl_lib/mysql-connector-java-commercial-5.0.3-bin.jar
mysql_jdbc=$jrf_dir/modules/mysql-connector-java-commercial-5.1.17/mysql-connector-java-commercial-5.1.17-bin.jar

mtplugins=$base_dir/jlib/netua.jar:$base_dir/jlib/modplsqlua.jar:$base_dir/jlib/portalua.jar:$base_dir/jlib/dipua.jar:$base_dir/jlib/webcacheua.jar:$base_dir/jlib/ohsua.jar:$base_dir/jlib/ovdua.jar:$base_dir/jlib/discoua.jar:$base_dir/jlib/formsua.jar:$base_dir/jlib/reportsua.jar:$base_dir/jlib/oifua.jar:$base_dir/jlib/odiua.jar:$base_dir/jlib/biua.jar:$base_dir/jlib/oamua.jar:$base_dir/jlib/oimua.jar:$base_dir/jlib/oaamua.jar:$base_dir/jlib/ucmua.jar:$base_dir/jlib/bipua.jar


mrplugins=$base_dir/jlib/PortalPlugin.jar:$base_dir/jlib/PcPlugin.jar:$base_dir/jlib/BIPlatformPlugin.jar:$base_dir/jlib/RtdPlugin.jar:$base_dir/jlib/OaamPlugin.jar:$base_dir/jlib/UcmPlugin.jar:$base_dir/jlib/UrmPlugin.jar:$base_dir/jlib/OimPlugin.jar:$base_dir/jlib/OdiPlugin.jar:$base_dir/jlib/OidPlugin.jar:$base_dir/jlib/DiscovererPlugin.jar:$base_dir/jlib/MrcVersionPlugin.jar:$base_dir/jlib/postgresql-8.4-701.jdbc4.jar:$datadirect_wls:$mysql_jdbc


# b2b dependency
b2bdep=$jrf_dir/modules/oracle.jrf_11.1.1/jrf-api.jar:$jrf_dir/modules/oracle.mds_11.1.1/mdsrt.jar:$jrf_dir/modules/oracle.adf.share.ca_11.1.1/adf-share-base.jar:$jrf_dir/modules/oracle.adf.share_11.1.1/adflogginghandler.jar:$jrf_dir/modules/oracle.ucp_11.1.0.jar:$jrf_dir/modules/oracle.adf.model_11.1.1/jdev-cm.jar:$jrf_dir/modules/oracle.javacache_11.1.1/cache.jar:$jrf_dir/modules/oracle.xmlef_11.1.1/xmlef.jar:$base_dir/soa/modules/oracle.soa.mgmt_11.1.1/soa-infra-mgmt.jar:$base_dir/soa/modules/oracle.soa.fabric_11.1.1/fabric-runtime.jar:$jrf_dir/modules/oracle.fabriccommon_11.1.1/fabric-common.jar:$base_dir/soa/modules/oracle.soa.b2b_11.1.1/b2b.jar:$jrf_dir/modules/oracle.adf.share_11.1.1/oracle-el.jar:$jrf_dir/modules/oracle.adf.share_11.1.1/commons-el.jar:$jrf_dir/modules/oracle.xdk_11.1.0/xml.jar:$MW_HOME/modules/javax.jms_1.1.1.jar:$MW_HOME/modules/javax.jsp_1.1.0.0_2-1.jar

# oim dependencies
oimdir=$base_dir/server/apps/oim.ear/APP-INF/lib

oimrecupg=$oimdir/iam-platform-auth-client.jar:$oimdir/iam-platform-auth-server.jar:$oimdir/iam-platform-context.jar:$oimdir/iam-platform-kernel.jar:$oimdir/xlVO.jar:$oimdir/xlAPI.jar:$oimdir/xlAuditor.jar:$oimdir/xlDataObjectBeans.jar:$oimdir/xlmap.xml:$oimdir/xlCache.jar:$oimdir/xlUtils.jar:$oimdir/oscache.jar:$base_dir/server/ext/ucp.jar:$jrf_dir/modules/oracle.adf.share.ca_11.1.1/adf-share-ca.jar:$jrf_dir/modules/oracle.xmlef_11.1.1/xmlef.jar:$jrf_dir/modules/oracle.javacache_11.1.1/cache.jar:$jrf_dir/modules/com.bea.core.apache.commons.logging_1.1.0.jar:$jrf_dir/modules/com.oracle.ocm_1.0.0.0.jar:$jrf_dir/inventory/Scripts/ext/jlib/ojdbc6.jar:$jrf_dir/jlib/share.jar

oimdep=$jrf_dir/modules/oracle.adf.model_11.1.1/adfm.jar:$SOA_HOME/soa/modules/oracle.rules_11.1.1/rulesdk2.jar:$SOA_HOME/soa/modules/oracle.rules_11.1.1/rules.jar:$SOA_HOME/soa/modules/oracle.soa.fabric_11.1.1/bpm-infra.jar:$SOA_HOME/soa/modules/oracle.soa.workflow_11.1.1/bpm-services.jar:$jrf_dir/soa/modules/commons-cli-1.1.jar:$jrf_dir/soa/modules/oracle.soa.mgmt_11.1.1/soa-infra-mgmt.jar:$oimdir/OIMServer.jar:$oimdir/quartz-1.6.0.jar:$oimdir/velocity-dep-1.4.jar:$oimdir/velocity-tools-1.4.jar:$oimdir/velocity-tools-generic-1.3.jar:$oimdir/commons-logging.jar:$oimdir/commons-dbcp-1.2.1.jar:$base_dir/server/ext/jakarta-commons/commons-pool-1.2.jar:$base_dir/server/ext/jakarta-commons/commons-collections-3.1.jar:$oimdir/xlGenConnector.jar:$oimdir/iam-platform-entitymgr.jar:$oimdir/iam-platform-utils.jar:$oimdir/spring.jar:$jrf_dir/modules/oracle.idm_11.1.1/identityutils.jar:$base_dir/server/apps/oim.ear/iam-ejb.jar:$base_dir/../oracle_common/modules/oracle.adf.share.ca_11.1.1:$oimdir/iam-platform-pluginframework.jar:$oimdir/xlDataObjects.jar:$oimdir/iam-platform-authz-service.jar:$base_dir/server/apps/oim.ear/admin.war/WEB-INF/lib/iam-features-identity.zip:$base_dir/server/features/iam-features-configservice.zip:$base_dir/server/features/iam-features-authzpolicydefn.zip:$base_dir/server/oes/oimpds.jar:$base_dir/../oracle_common/modules/oracle.nlsgdk_11.1.0/orai18n-service.jar:$base_dir/server/seed_data/lib/seedPolicyData.jar:$base_dir/server/seed_data/lib/seedRcuData.jar:$oimrecupg:$MW_HOME/modules/org.apache.ant_1.7.1/lib/ant.jar:$MW_HOME/modules/org.apache.ant_1.7.1/lib/ant-launcher.jar

# odi dependencies
odidir=$base_dir/oracledi.sdk/lib
odimod=$base_dir/oracledi.sdk/modules
odimisc=$base_dir/odi_misc
odidep=$odimod/oracle.jps_11.1.1/jps-api.jar:$odimod/oracle.idm_11.1.1/identitystore.jar:$odidir/ojdl.jar:$odimisc/wlclient.jar:$odimisc/ojmisc.jar:$odimisc/dms.jar:$odimisc/help-share.jar:$odimisc/ohj.jar:$odimisc/oracle_ice.jar:$odimisc/xmlparserv2.jar:$odimisc/orai18n-mapping.jar:$odimisc/share.jar:$odimisc/fmwgenerictoken.jar:$odimisc/wlinformix.jar:$odimisc/wlsybase.jar:$odimisc/wldb2.jar:$odimisc/wlsqlserver.jar:$odidir/ant-commons-net.jar:$odidir/bsf.jar:$odidir/bsh-2.0b2.jar:$odidir/commons-beanutils-1.7.0.jar:$odidir/commons-collections-3.2.jar:$odidir/commons-io-1.2.jar:$odidir/commons-lang-2.2.jar:$odidir/commons-logging-1.1.1.jar:$odidir/eclipselink.jar:$odidir/ess.jar:$odidir/javolution.jar:$odidir/odi-core.jar:$odidir/oracle.ucp_11.1.0.jar:$odidir/persistence.jar:$odidir/spring-beans.jar:$odidir/spring-context.jar:$odidir/spring-core.jar:$odidir/spring-dao.jar:$odidir/spring-jdbc.jar:$odidir/spring-jpa.jar:$odidir/trove.jar:$odidir:$odidir/hsqldb.jar

# NOTE: vde.jar must be before weblogic.jar
#       weblogic.jar must be before wlfullclient.jar
#
NEWJARS=$jrf_dir/modules/oracle.odl_11.1.1/ojdl.jar:$jrf_dir/modules/oracle.dms_11.1.1/dms.jar:$jrf_dir/modules/oracle.bali.share_11.1.1/share.jar:$jrf_dir/modules/oracle.ldap_11.1.1/ldapjclnt11.jar:$jrf_dir/modules/oracle.xdk_11.1.0/xmlparserv2.jar:$jrf_dir/modules/oracle.jps_11.1.1/jps-manifest.jar:$jrf_dir/modules/oracle.iau_11.1.1/fmw_audit.jar:$jrf_dir/modules/oracle.jmx_11.1.1/jmxframework.jar:$jrf_dir/modules/oracle.jmx_11.1.1/jmxspi.jar:$jrf_dir/modules/oracle.pki_11.1.1/oraclepki.jar:$jrf_dir/modules/oracle.osdt_11.1.1/osdt_core.jar:$jrf_dir/modules/oracle.osdt_11.1.1/osdt_cert.jar:$jrf_dir/modules/oracle.idm_11.1.1/identitystore.jar:$jrf_dir/modules/oracle.ldap_11.1.1/ojmisc.jar:$MW_HOME/modules/javax.management.j2ee_1.0.jar:$base_dir/upgrade/jlib/com.oracle.ws.http_client_1.1.0.0.jar:$jrf_dir/modules/oracle.help_5.0/help-share.jar:$jrf_dir/modules/oracle.help_5.0/ohj.jar:$jrf_dir/modules/oracle.help_5.0/oracle_ice.jar:$jrf_dir/modules/oracle.jps_11.1.1/jps-wls.jar:$base_dir/ovd/jlib/vde.jar:$WL_HOME/server/lib/weblogic.jar:$WL_HOME/server/lib/consoleapp/APP-INF/lib/commons-codec-1.3.jar:$jrf_dir/modules/oracle.osdt_11.1.1/osdt_xmlsec.jar

BIMBEANS=$base_dir/bifoundation/jlib/biconfigmbeans.jar:$base_dir/bifoundation/jlib/biconfigmbeans-metaobjs.jar
ADMINMBEANS=$base_dir/bifoundation/admin/provisioning/adminservicesmbeans.jar

BIEEMBEANS=$base_dir/bifoundation/jlib/oracle-bi-public.jar:$base_dir/bifoundation/jlib/oracle-bi-shared.jar

CSFJARS=$jrf_dir/modules/oracle.jps_11.1.1/jps-common.jar:$jrf_dir/modules/oracle.jps_11.1.1/jps-manifest.jar:$jrf_dir/modules/oracle.jps_11.1.1/jps-ee.jar:$jrf_dir/modules/oracle.jps_11.1.1/jps-mbeans.jar:$jrf_dir/modules/oracle.jps_11.1.1/jacc-spi.jar:$jrf_dir/modules/oracle.jps_11.1.1/jps-internal.jar:$jrf_dir/modules/oracle.jps_11.1.1/jps-api.jar:$jrf_dir/modules/oracle.jps_11.1.1/jps-platform.jar:$jrf_dir/modules/oracle.jps_11.1.1/jps-unsupported-api.jar:$base_dir/bifoundation/admin/provisioning/bisecurityprovision.jar

VACRULESOA=$base_dir/../oracle_common/modules/oracle.xdk_11.1.0/xml.jar:$base_dir/../oracle_common/modules/oracle.xdk_11.1.0/xmlparserv2.jar:$SOA_HOME/soa/modules/oracle.soa.workflow_11.1.1/bpm-services.jar:$base_dir/../oracle_common/modules/oracle.fabriccommon_11.1.1/fabric-common.jar:$base_dir/../oracle_common/modules/oracle.webservices_11.1.1/wsclient.jar:$base_dir/../oracle_common/modules/oracle.jps_11.1.1/jps-manifest.jar:$base_dir/../Oracle_SOA1/soa/modules/oracle.soa.fabric_11.1.1/bpm-infra.jar:$base_dir/../Oracle_SOA1/soa/modules/oracle.soa.fabric_11.1.1/oracle-soa-client-api.jar

# NOTE: $odidep must be before $mrplugins
#
CLASSPATH=$BIMBEANS:$ADMINMBEANS:$BIEEMBEANS:$BIUAPATH:$CSFJARS:$NEWJARS:$BIPROVISIONING:$base_dir/jlib/netcfg.jar:$base_dir/jlib/ua.jar:$base_dir/jlib/mrua.jar:$mtplugins:$odidep:$mrplugins:$b2bdep:$base_dir/jlib/jewt4.jar:$OUI_HOME/jlib/OraInstaller.jar:$OUI_HOME/jlib/srvm.jar:$base_dir/jlib/SchemaVersion.jar:$base_dir/webservices/lib/jaxrpc-api.jar:$base_dir/assistants/opca/jlib/opca.jar:$base_dir/portal/jlib/ptlshare.jar:$base_dir/portal/jlib/portaltools.jar:$base_dir/adfp/lib/wce.jar:$base_dir/ldap/odi/jlib/sync.jar:$base_dir/ldap/odi/jlib/madintegrator.jar:$base_dir/ohs/lib/ohs.jar:$base_dir/opmn/lib/iasprovision.jar:$base_dir/opmn/lib/optic.jar:$base_dir/opmn/lib/nonj2eembeans.jar:$base_dir/opmn/lib/wlfullclient.jar:$base_dir/opmn/lib/opmneditor.jar:$base_dir/lib/java/shared/args4j/2.0.9/args4j-2.0.9.jar:$base_dir/oam/server/lib/ojmisc.jar:$base_dir/ucm/idc/jlib/idcupgrade.jar:$VACRULESOA:$jrf_dir/webservices/wsclient_extended.jar:$base_dir/clients/bipublisher/xdo-server.jar:$base_dir/clients/bipublisher/xdo-core.jar:$base_dir/clients/bipublisher/versioninfo.jar:$base_dir/clients/bipublisher/i18nAPI_v3.jar:$base_dir/common/SharedServices/11.1.2.0/lib/quartz.jar:$base_dir/clients/bipublisher/gson-1.3.jar:$ojdbc:$oimdep

export CLASSPATH

# Adding -Dbam.reuseDumpfile=true will cause BAM to upgrade skip the export
# of 10g data from the source database, and skip creating the dumpfile. 
# Instead, BAM will just do the import again, reusing the existing logfile & 
# running Morpheus again.  This can save many hours in error recovery cases.
# The following flag settings are not supported by Oracle in 11.1.1.0.0
# -Dua.testConnection=true enables diagnostic testing of DB connectivity
# -Dua.nonOracle=true enables non-Oracle database connectivity
# -Dua.forceBiHome=true causes Upgrade Assistant to treat this as a BI home
#
#echo ${CLASSPATH}
$JAVA_HOME/bin/java ${JAVAMODE}  ${MAXPERMSIZE} -Xms512m -Xmx512m -classpath ${CLASSPATH} -Dua.home=$base_dir -Dua.mw.home=$MW_HOME -Dua.wl.home=$WL_HOME -Dice.pilots.html4.ignoreNonGenericFonts=true -Dsun.lang.ClassLoader.allowArraySyntax=true -Doracle.installer.oui_loc=$OUI_HOME oracle.ias.upgrade.UpgradeDriver "$@"

