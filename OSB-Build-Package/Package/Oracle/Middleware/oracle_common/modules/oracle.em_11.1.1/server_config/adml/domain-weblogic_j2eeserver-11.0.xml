<?xml version='1.0' encoding='UTF-8' ?>

<!-- Copyright (c) 2009, 2010, Oracle and/or its affiliates. 
All rights reserved. -->

<!--
   This file contains the metric rules for the WebLogic Server.  It contains
   rules that must be evaluated by looking at all servers in the domain. This is 
   necessary for the Response metric since a server will only have a runtime
   mbean if it is up.  In this case, we need to look at all ServerRuntime mbeans
   in the domain and see if we can find the one that we are looking for.

   MODIFIED    (MM/DD/YY)
   scgrover     06/21/10 - fix response
   klmichae     02/10/09 - Initial version
-->

<Adml xmlns="http://www.oracle.com/iAS/aggregator"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      TableSpace="weblogic_j2eeserver">

 <!-- Response (published) -->
 <Table Name="Response">
  <ColumnDef Name="serverName" Type="String" Key="true"/>
  <ColumnDef Name="Status" Type="Integer"/>
  <Select Name="Response_from_serverRuntime">
   <TableFrom Name="weblogic.management.runtime.ServerRuntimeMBean"/>
   <Column Name="serverName" Type="String">
    <ColumnFrom Name="Name"/>
   </Column>
   <Column Name="Status" Type="Integer">
    <If>
     <Condition Operator="EQ">
      <ColumnFrom Name="StateVal"/>
      <Value>2</Value>
     </Condition>
    <Then>
      <Value>1</Value>
    </Then>
    <Else>
      <Value>0</Value>
    </Else>
    </If>
   </Column>

   <!-- Look for the specified server -->
   <Where>
    <Condition Type="String" Operator="EQ">
     <ColumnFrom Name="serverName"/>
     <Value Name="ServerNames.parameter"/>
    </Condition>
   </Where>

  </Select>

  <Select Name="Response_result_count">
   <TableFrom Name="Response_from_serverRuntime"/>

   <!-- If the server is down, there will be no runtime mBean. -->
   <!-- The number of rows will be zero.  In this case, return 0. -->
   <Column Name="numRows" Type="Integer">
    <Aggregation Operator="Count"/>
    <Default>0</Default>
   </Column>
   <Column Name="Status" Type="Integer">
     <Aggregation Operator="Max" Name="Status"/>
   </Column>
  </Select>

  <Select Name="Response_result">
   <TableFrom Name="Response_result_count"/>
   <Column Name="Status" Type="Integer">
    <If>
     <Condition Operator="GT">
      <ColumnFrom Name="numRows"/>
      <Value>0</Value>
     </Condition>

     <Then>
      <ColumnFrom Name="Status"/>
     </Then>

     <Else>
      <Value>0</Value>
     </Else>
    </If>
    <Default>0</Default>
   </Column>
  </Select>
 </Table> 

</Adml>
