# M270NBUX.def: Collects Extended NetBackup Information
# $Id: M270NBUX.def,v 1.2 2012/08/17 14:26:54 mschenke Exp $
# ARCS: $Header: /home/cvs/cvs/RDA_4/src/scripting/lib/modules/M270NBUX.def,v 1.2 2012/08/17 14:26:54 mschenke Exp $
#
# Change History
# 20120817  JGS  Report nbsu files.

=head1 NAME

M270NBUX - Collects NetBackup Extended Information

=head1 DESCRIPTION

This module collects extended information about NetBackup product.

=cut

use Mrc

# Initialization
var $VALIDATE = true
keep $VALIDATE

section begin

var $ERR = '---## Associated Errors'
var $TOC = '%TOC%'
var $TOP = '[[#Top][Back to top]]'
var $WRN = '* Links point to files that have been collected in their original \
              format. Opening them directly in your browser can present risks. \
              To prevent them, access the file outside the browser or use the \
              link to save them and use an adequate viewer.'

run XPLRlib('nbu_extended')

#------------------------------------------------------------------------------
# XPLR_nbu_extended section
#------------------------------------------------------------------------------

section XPLR_nbu_extended

# Validate the execution context
if !${XPLR_GLOBAL:true}
 return
call log_run('Processing NBUX sections ...')
if !testDir('d','/usr/openv')
 return log_info('NetBackup not installed')

=head2 nbux - NetBackup Extended

Gathers NetBackup extended information collecting the following commands:

=over 2

=item o C</usr/bin/ls -larTR /usr/openv>

=item o C</usr/openv/netbackup/bin/admincmd/bppllist -allpolicies -U>

=item o C</usr/openv/netbackup/bin/admincmd/bpcllist -allclasses -U>

=item o C</usr/openv/netbackup/bin/admincmd/bpconfig -U>

=item o C</usr/openv/netbackup/bin/admincmd/bpdbjobs -all_columns>

=item o C</usr/openv/netbackup/bin/admincmd/bpdbjobs -report>

=item o C</usr/openv/netbackup/bin/admincmd/bpdbjobs -summary>

=item o C</usr/openv/netbackup/bin/admincmd/bperror -U -all -d 01/30/00
 00:00:00>

=item o C</usr/openv/netbackup/bin/admincmd/bperror -U -media -d 01/30/00
 00:00:00>

=item o C</usr/openv/netbackup/bin/admincmd/bpgetconfig>

=item o C</usr/openv/netbackup/bin/admincmd/bpimagelist -A -d 01/30/00 00:00:00>

=item o C</usr/openv/netbackup/bin/admincmd/bpimagelist -A -media -d 01/30/00
 00:00:00>

=item o C</usr/openv/netbackup/bin/admincmd/bpimmedia -U>

=item o C</usr/openv/netbackup/bin/admincmd/bpmedialist -U -mlist>

=item o C</usr/openv/netbackup/bin/admincmd/bpmedialist -summary>

=item o C</usr/openv/netbackup/bin/admincmd/bpmedialist -summary -brief>

=item o C</usr/openv/netbackup/bin/admincmd/bpplclients>

=item o C</usr/openv/netbackup/bin/admincmd/bpstulist -U -verbose>

=item o C</usr/openv/netbackup/bin/admincmd/bpsyncinfo -U>

=item o C</usr/openv/netbackup/bin/admincmd/get_license_key -L features>

=item o C</usr/openv/netbackup/bin/admincmd/get_license_key -L keys>

=item o C</usr/openv/netbackup/bin/bpclimagelist>

=item o C</usr/openv/netbackup/bin/bpps -a>

=item o C</usr/openv/netbackup/bin/goodies/available_media>

=item o C</usr/openv/netbackup/bin/goodies/support>

=item o C</usr/openv/netbackup/bin/goodies/support/support>

=item o C</usr/openv/volmgr/bin/tpclean -L>

=item o C</usr/openv/volmgr/bin/vmpool -listall>

=item o C</usr/openv/volmgr/bin/vmquery -a>

=item o C</usr/openv/volmgr/bin/vmquery -a -bx>

=item o C</usr/openv/volmgr/bin/vmquery -a -w>

=item o C</usr/openv/volmgr/bin/vmrule -listall>

=back

Collects the following related files:

=over 2

=item o F</usr/openv/java/*conf>

=item o F</usr/openv/java/JBPSimple.properties>

=item o F</usr/openv/java/Launch.properties>

=item o F</usr/openv/java/Xenv>

=item o F</usr/openv/java/logs/*>

=item o F</usr/openv/netbackup/bin/*notify*>

=item o F</usr/openv/netbackup/bin/support/${NBUDIR}/*.txt>

=item o F</usr/openv/netbackup/bin/version>

=item o F</usr/openv/netbackup/bp.conf>

=item o F</usr/openv/netbackup/db/Class_att_defs>

=item o F</usr/openv/netbackup/db/IDIRSTRUCT>

=item o F</usr/openv/netbackup/db/INDEXLEVEL>

=item o F</usr/openv/netbackup/db/bpenableLN.scr>

=item o F</usr/openv/netbackup/db/bpenableTD.scr>

=item o F</usr/openv/netbackup/db/class/*>

=item o F</usr/openv/netbackup/db/class_template/*>

=item o F</usr/openv/netbackup/db/client/*>

=item o F</usr/openv/netbackup/db/config/*>

=item o F</usr/openv/netbackup/db/error/*>

=item o F</usr/openv/netbackup/db/failure_history/*>

=item o F</usr/openv/netbackup/db/images/*/INDEXLEVEL>

=item o F</usr/openv/netbackup/db/jobs/*>

=item o F</usr/openv/netbackup/db/media/*>

=item o F</usr/openv/netbackup/version>

=item o F</usr/openv/volmgr/bin/driver/sg.conf*>

=item o F</usr/openv/volmgr/bin/driver/sg.links*>

=item o F</usr/openv/volmgr/version>

=back

=cut

debug ' Inside NBUX collection, gathering NetBackup extended information'

# Determine the commands and files to collect
var (@cmd,@fil) = ({cmd => 'TITLE',\
                    txt => '---+ NetBackup Extended Information'})
var %lnk = ()

if is_pkg_installed('SYMCnetbp')
{call push(@cmd,\
   {cmd => 'COMMENT',nam => 'nbu/cmd/SYMCnetbp', txt => ''},\
   ['nbu/cmd/support.txt',\
    '/usr/openv/netbackup/bin/goodies/support/support',undef,\
    '---++ NetBackup Data Collection Tool',true])

 # Get a sandbox directory to capture nbsu output command
 var $box = cleanBox()
 var $job = createTemp('NBU','.sh',true)
 call writeTemp('NBU','cd "',$box,'"')
 call writeTemp('NBU','/usr/openv/netbackup/bin/support/nbsu -nozip -t')
 call closeTemp('NBU')
 var @ret = command(quote($job,'x'))
 call unlinkTemp('NBU')
 var (undef,$dir) = split('\s+',pop(@ret),3)
 var ($dir,@ret) = (catDir($box,$dir))

 # Extract tar files at the right place. No -C available on Solaris tar cmd
 var $job = createTemp('TAR','.sh',true)
 call writeTemp('TAR','cd "',$dir,'"')
 call writeTemp('TAR','/usr/sbin/tar -xf *.tar >/dev/null 2>&1')
 call closeTemp('TAR')
 call command(quote($job,'x'))
 call unlinkTemp('TAR')

 # Collect all the *.txt files generated by nbsu command
 loop $fil (grepDir($dir,'.*\.txt$','n'))
  var ($lnk{$fil}) = collectFile(concat('nbu/cmd/nbsu/',$fil),\
    catFile($dir,$fil),['C',concat('nbsu (',$fil,')')])
}
elsif is_pkg_installed('VRTSnetbp')
 call push(@cmd,\
   {cmd => 'COMMENT',nam => 'nbu/cmd/VRTSnetbp', txt => ''},\
   ['nbu/cmd/support.txt',\
    '/usr/openv/netbackup/bin/goodies/support/support',undef,\
    '---++ NetBackup Data Collection Tool',true])
elsif is_pkg_installed('SUNWnetbp')
 call push(@cmd,\
   {cmd => 'COMMENT',nam => 'nbu/cmd/SUNWnetbp', txt => ''},\
   ['nbu/cmd/support.txt',\
    '/usr/openv/netbackup/bin/goodies/support',undef,\
    '---++ NetBackup Data Collection Tool',true])

# Push other commands to be collected
call push(@cmd,\
  ['nbu/cmd/available_media.txt',\
   '/usr/openv/netbackup/bin/goodies/available_media',undef,\
   '---++ Show Available Media',true],\
  ['nbu/cmd/bpclimagelist.txt',\
   '/usr/openv/netbackup/bin/bpclimagelist',undef,\
   '---++ Image Status',true],\
  ['nbu/cmd/bpconfig-U.txt',\
   '/usr/openv/netbackup/bin/admincmd/bpconfig','-U',\
   '---++ Global Configuration Attributes',true],\
  ['nbu/cmd/bpdbjobs-all_columns.txt',\
   '/usr/openv/netbackup/bin/admincmd/bpdbjobs','-all_columns',\
   '---++ Jobs Report All Contents',true],\
  ['nbu/cmd/bpdbjobs-report.txt',\
   '/usr/openv/netbackup/bin/admincmd/bpdbjobs','-report',\
   '---++ Jobs Report',true],\
  ['nbu/cmd/bpdbjobs-summary.txt',\
   '/usr/openv/netbackup/bin/admincmd/bpdbjobs','-summary',\
   '---++ Jobs Summary',true],\
  ['nbu/cmd/bperror-U-all.txt',\
   '/usr/openv/netbackup/bin/admincmd/bperror',\
   '-U -all -d 01/30/00 00:00:00',\
   '---++ Error Catalog',true],\
  ['nbu/cmd/bperror-U-media.txt',\
   '/usr/openv/netbackup/bin/admincmd/bperror',\
   '-U -media -d 01/30/00 00:00:00',\
   '---++ Error Media Catalog',true],\
  ['nbu/cmd/bpgetconfig.txt',\
   '/usr/openv/netbackup/bin/admincmd/bpgetconfig',undef,\
   '---++ Configuration Information',true],\
  ['nbu/cmd/bpimagelist-A-media.txt',\
   '/usr/openv/netbackup/bin/admincmd/bpimagelist',\
   '-A -media -d 01/30/00 00:00:00',\
   '---++ Media Image List',true],\
  ['nbu/cmd/bpimagelist-A.txt',\
   '/usr/openv/netbackup/bin/admincmd/bpimagelist',\
   '-A -d 01/30/00 00:00:00',\
   '---++ Image List',true],\
  ['nbu/cmd/bpimmedia-U.txt',\
   '/usr/openv/netbackup/bin/admincmd/bpimmedia','-U',\
   '---++ Images on Media',true],\
  ['nbu/cmd/bpmedialist-U-mlist.txt',\
   '/usr/openv/netbackup/bin/admincmd/bpmedialist','-U -mlist',\
   '---++ Media Status',true],\
  ['nbu/cmd/bpmedialist-summary-brief.txt',\
   '/usr/openv/netbackup/bin/admincmd/bpmedialist','-summary -brief',\
   '---++ Media Status Brief',true],\
  ['nbu/cmd/bpmedialist-summary.txt',\
   '/usr/openv/netbackup/bin/admincmd/bpmedialist','-summary',\
   '---++ Media Status Summary',true])
if testFile('f','/usr/openv/netbackup/bin/admincmd/bpplclients')
 call push(@cmd,\
   ['nbu/cmd/bpplclients.txt',\
    '/usr/openv/netbackup/bin/admincmd/bpplclients',undef,\
    '---++ Clients for all Policies',true])
else
 call push(@cmd,\
   ['nbu/cmd/bpclclients.txt',\
    '/usr/openv/netbackup/bin/admincmd/bpclclients',undef,\
    '---++ Clients for all Policies',true])
if testFile('f','/usr/openv/netbackup/bin/admincmd/bppllist')
 call push(@cmd,\
   ['nbu/cmd/bppllist-allpolicies.txt',\
    '/usr/openv/netbackup/bin/admincmd/bppllist','-allpolicies -U',\
    '---++ Policy Information',true])
else
 call push(@cmd,\
   ['nbu/cmd/bpcllist-allclasses.txt',\
    '/usr/openv/netbackup/bin/admincmd/bpcllist','-allclasses -U',\
    '---++ Policy Information',true])
call push(@cmd,\
   ['nbu/cmd/bpps-a.txt',\
    '/usr/openv/netbackup/bin/bpps','-a',\
    '---++ Processes',true],\
   ['nbu/cmd/bpstulist-U-verbose.txt',\
    '/usr/openv/netbackup/bin/admincmd/bpstulist','-U -verbose',\
    '---++ Storage Units',true],\
   ['nbu/cmd/bpsyncinfo-U.txt',\
    '/usr/openv/netbackup/bin/admincmd/bpsyncinfo','-U',\
    '---++ Database Backup Settings',true],\
   ['nbu/cmd/get_license_key-L.features.txt',\
    '/usr/openv/netbackup/bin/admincmd/get_license_key','-L features',\
    '---++ License Features',true],\
   ['nbu/cmd/get_license_key-L.keys.txt',\
    '/usr/openv/netbackup/bin/admincmd/get_license_key','-L keys',\
    '---++ License Keys',true],\
   ['nbu/cmd/ls_-larTR_@usr@openv',\
    '/usr/bin/ls','-larTR /usr/openv',\
    '---++ File Listing'],\
   ['nbu/cmd/tpclean-L.txt',\
    '/usr/openv/volmgr/bin/tpclean','-L',\
    '---++ Tape Cleaning Statistics',true],\
   ['nbu/cmd/vmpool-listall.txt',\
    '/usr/openv/volmgr/bin/vmpool','-listall',\
    '---++ Volume Pools',true],\
   ['nbu/cmd/vmquery-a-bx.txt',\
    '/usr/openv/volmgr/bin/vmquery','-a -bx',\
    '---++ Volume Database Listing',true],\
   ['nbu/cmd/vmquery-a.txt',\
    '/usr/openv/volmgr/bin/vmquery','-a',\
    '---++ Volume Details',true],\
   ['nbu/cmd/vmquery-w.txt',\
    '/usr/openv/volmgr/bin/vmquery','-a -w',\
    '---++ Volume Database Extended Listing',true],\
   ['nbu/cmd/vmrule-listall.txt',\
    '/usr/openv/volmgr/bin/vmrule','-listall',\
    '---++ Barcode Rules',true],\
   {cmd => 'UNTITLE'})

# Push files and directories to be collected
call push(@fil,\
  ['nbu/nblog.conf'               ,'/usr/openv/netbackup/nblog.conf'],\
  ['nbu/bp.conf'                  ,'/usr/openv/netbackup/bp.conf'],\
  ['nbu/version'                  ,'/usr/openv/netbackup/version'],\
  ['nbu/bin'                      ,'/usr/openv/netbackup/bin',\
   '','','.*notify.*'],\
  ['nbu/bin/version'              ,'/usr/openv/netbackup/bin/version'],\
  ['nbu/db/Class_att_defs'        ,'/usr/openv/netbackup/db/Class_att_defs'],\
  ['nbu/db/IDIRSTRUCT'            ,'/usr/openv/netbackup/db/IDIRSTRUCT'],\
  ['nbu/db/INDEXLEVEL'            ,'/usr/openv/netbackup/db/INDEXLEVEL'],\
  ['nbu/db/bpenableLN.scr'        ,'/usr/openv/netbackup/db/bpenableLN.scr'],\
  ['nbu/db/bpenableTD.scr'        ,'/usr/openv/netbackup/db/bpenableTD.scr'],\
  ['nbu/db/class'                 ,'/usr/openv/netbackup/db/class',\
   '','','^\.+$','drv'],\
  ['nbu/db/class_template'        ,'/usr/openv/netbackup/db/class_template',\
   '','','^\.+$','drv'],\
  ['nbu/db/client'                ,'/usr/openv/netbackup/db/client',\
   '','','^\.+$','drv'],\
  ['nbu/db/config'                ,'/usr/openv/netbackup/db/config',\
   '','','^\.+$','drv'],\
  ['nbu/db/error'                 ,'/usr/openv/netbackup/db/error',\
   '','','^\.+$','drv'],\
  ['nbu/db/failure_history'       ,'/usr/openv/netbackup/db/failure_history',\
   '','','^\.+$','drv'],\
  ['nbu/db/images'                ,'/usr/openv/netbackup/db/images',\
   '','','^.*/INDEXLEVEL$'],\
  ['nbu/db/jobs'                  ,'/usr/openv/netbackup/db/jobs',\
   '','','^\.+$','drv'],\
  ['nbu/db/media'                 ,'/usr/openv/netbackup/db/media',\
   '','','^\.+$','drv'],\
  ['nbu/java'                     ,'/usr/openv/java','','','.*conf$'],\
  ['nbu/java/JBPSimple.properties','/usr/openv/java/JBPSimple.properties'],\
  ['nbu/java/Launch.properties'   ,'/usr/openv/java/Launch.properties'],\
  ['nbu/java/Xenv'                ,'/usr/openv/java/Xenv'],\
  ['nbu/java/logs'                ,'/usr/openv/java/logs',\
   '','','^\.+$','drv'],\
  ['nbu/logs'                     ,'/usr/openv/netbackup/logs',\
   '','','^\.+$','drv'],\
  ['nbu/vault/config_files'       ,'/usr/openv/netbackup/db/vault',\
   '','','^\.+$','drv'],\
  ['nbu/vault/sessions'           ,'/usr/openv/netbackup/vault/sessions',\
   '','','^\.+$','drv'],\
  ['nbu/volmgr'                   ,'/usr/openv/volmgr/version'],\
  ['nbu/volmgr/bin/driver'        ,'/usr/openv/volmgr/bin/driver',\
   '','','^sg\.conf.*'],\
  ['nbu/volmgr/bin/driver'        ,'/usr/openv/volmgr/bin/driver',\
   '','','^sg\.links.*'],\
  ['nbu/volmgr/debug'             ,'/usr/openv/volmgr/debug',\
   '','','^\.+$','drv'])

# Generate the report
report nbux
title '---+!! NetBackup Extended'
title $TOC

debug ' Inside NBUX collection, collecting commands'
call do_exec(@cmd)

debug ' Inside NBUX collection, collecting files'
prefix
{write '---+ Collected files'
 write $WRN
 write '|*File Path*| *Size*|*Last Modified Date*|'
}
call do_collect_fil(@fil)
if hasOutput(true)
 write $TOP

# Include nbsu files
prefix
{write '---+ NetBackup Support Utility Results'
 write $WRN
 write '|*File*|'
}
loop $fil (keys(%lnk))
 write '|[[',$lnk{$fil},'][_blank][',$fil,']]|'
if hasOutput(true)
 write $TOP

# Add the report to the table of content
if isCreated(true)
 toc '2:[[',getFile(),'][rda_report][NetBackup Extended]]'

=head1 SEE ALSO

L<S150XPLR.def|modules::S150XPLR>,
L<XPLRlib.def|modules::XPLRlib>

=head1 COPYRIGHT NOTICE

Copyright (c) 2002, 2012, Oracle and/or its affiliates. All rights reserved.

=head1 TRADEMARK NOTICE

Oracle and Java are registered trademarks of Oracle and/or its
affiliates. Other names may be trademarks of their respective owners.

=cut
